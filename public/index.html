<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container_login" id="login">
        <h2>Login</h2>
        <input id="login-username" type="text" placeholder="Username">
        <input id="login-password" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button class="toggle-button" onclick="showRegister()">Register</button>
    </div>
    <div class="container_login" id="register">
        <h2>Register</h2>
        <input id="reg-username" type="text" placeholder="Username">
        <input id="reg-password" type="password" placeholder="Password">
        <button onclick="register()">Register</button>
        <button class="toggle-button" onclick="showLogin()">Back to Login</button>
    </div>
    <div class="container" id="chat" style="display:none;">
        <div class="toolbar" id="toolbar">
            <h3>Chat Rooms</h3>
            <input id="room-input" type="text" placeholder="New Room">
            <button onclick="createRoom()">Create Room</button>
            <div id="rooms"></div>
        </div>
        <div class="chat-section">
            <div class="chat-header">
                <button id="settings-button" onclick="openSettings()">⚙️</button>
            </div>
            <div class="messages" id="messages"></div>
            <input id="message-input" type="text" placeholder="Type a message">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
    <div id="settings-overlay" class="overlay" style="display:none;">
        <div class="overlay-content">
            <h2>Chat Settings</h2>
            <button onclick="deleteChat()">Delete Chat</button>
            <button onclick="closeSettings()">Close</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let userId = null;
        let currentRoom = null;

        function showRegister() {
            document.getElementById('login').style.display = 'none';
            document.getElementById('register').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('register').style.display = 'none';
            document.getElementById('login').style.display = 'block';
        }

        function register() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            }).then(response => response.text())
              .then(data => alert(data));
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            }).then(response => response.text())
              .then(data => {
                  if (data === 'Login successful') {
                      userId = username;
                      document.getElementById('login').style.display = 'none';
                      document.getElementById('register').style.display = 'none';
                      document.getElementById('chat').style.display = 'flex';
                      loadRooms();
                  } else {
                      alert(data);
                  }
              });
        }

        function createRoom() {
            const room = document.getElementById('room-input').value;
            if (room.trim() !== '') {
                socket.emit('create_room', room);
                document.getElementById('room-input').value = '';
            }
        }

        function joinRoom(room) {
            currentRoom = room;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join_room', room);
        }

        function sendMessage() {
            const message = document.getElementById('message-input').value;
            if (message.trim() !== '' && currentRoom !== null) {
                socket.emit('new_message', { room: currentRoom, userId, message });
                document.getElementById('message-input').value = '';
            }
        }

        document.getElementById('message-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        socket.on('new_message', (data) => {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerText = `${data.userId}: ${data.message}`;
            document.getElementById('messages').appendChild(messageElement);
        });

        socket.on('load_messages', (messages) => {
            const messagesContainer = document.getElementById('messages');
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerText = `${message.user_id}: ${message.message}`;
                messagesContainer.appendChild(messageElement);
            });
        });

        socket.on('room_list', (rooms) => {
            const roomsContainer = document.getElementById('rooms');
            roomsContainer.innerHTML = ''; // Clear existing rooms
            rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room';
                roomElement.innerText = room;
                roomElement.onclick = () => joinRoom(room);
                roomsContainer.appendChild(roomElement);
            });
        });

        function loadRooms() {
            socket.emit('get_rooms');
        }

        function openSettings() {
            document.getElementById('settings-overlay').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settings-overlay').style.display = 'none';
        }

        function deleteChat() {
            const confirmation = prompt('Are you sure you want to delete this chat? Type "yes" to confirm.');
            if (confirmation === 'yes') {
                if (currentRoom !== null) {
                    socket.emit('delete_room', currentRoom);
                    currentRoom = null;
                    document.getElementById('messages').innerHTML = '';
                    loadRooms();
                    closeSettings();
                }
            }
        }
    </script>
</body>
</html>
